#############################################
# FILE: CursorRules.md
#############################################

# PROJECT PREDATOR v2.9
# CURSOR RULES & TECHNICAL CONSTITUTION
#
# This document is BINDING.
# All code, architecture and behavior generated by Cursor
# MUST strictly comply with these rules.
#
# If a conflict exists between profit and safety,
# safety ALWAYS wins.

################################################
## 1. LANGUAGE, STACK & RUNTIME RULES
################################################

- Language: Python 3.11+
- Backend Framework: FastAPI
- Frontend: React (Dashboard / Command Center)
- Async Model:
  - ALL I/O must use async/await
  - Blocking calls are FORBIDDEN
- Datastores:
  - SQLite (WAL mode) for state & trades
  - Redis for Pub/Sub, caching, agent communication
- Core Libraries:
  - ccxt.pro (WebSocket-first)
  - pandas-ta
  - numpy

Explanation:
This system is designed to be event-driven and non-blocking.
Any synchronous or blocking design introduces latency,
which directly translates to slippage and hidden risk.

################################################
## 2. CORE PHILOSOPHY (NON-NEGOTIABLE)
################################################

- Capital survival > Profit
- Risk controls override signals
- Vault capital is NEVER used for trading
- No single agent may have full control
- Every strategy must be replaceable at runtime

Explanation:
This system is NOT optimized for maximum short-term ROI.
It is optimized for long-term capital survival under uncertainty.
Any design that violates this philosophy is invalid.

################################################
## 3. ADAPTIVE RISK ENGINE (MANDATORY)
################################################

### 3.1 Kelly Criterion Usage

Kelly is used ONLY for position sizing.

EffectiveKelly =
BaseKelly
× VolatilityFactor
× DrawdownFactor
× LiquidityFactor

Rules:
- Kelly MUST be fractional
- Kelly MUST be regime-aware
- Kelly MUST NOT include leverage
- Max Effective Kelly is capped at 0.25
- If DrawdownFactor = 0 → NO NEW TRADES

Explanation:
Pure Kelly assumes IID outcomes and infinite liquidity.
Crypto markets violate both assumptions.
Therefore Kelly must be dampened, adaptive, and capped.

### 3.2 Drawdown Ladder (ENFORCED, NO EXCEPTIONS)

| Daily Drawdown | Mandatory Action |
|---------------|------------------|
| >= 2% | Reduce Kelly by 50% |
| >= 3% | Disable all new trades |
| >= 4% | Tighten all trailing stops |
| >= 5% | Kill switch + 12h system halt |

Explanation:
Drawdown is the earliest signal of edge degradation.
The system must respond BEFORE catastrophic loss occurs,
not after.

################################################
## 4. EXIT LOGIC CONSISTENCY
################################################

Only ONE primary exit logic may be active per trade.

Priority hierarchy:
1. Trailing Stop (default)
2. ROI Table (allowed ONLY in low volatility regimes)
3. Emergency Stoploss (always on, cannot be disabled)

Rules:
- Exit logic must be selected by Strategist MCP
- Exit logic must match volatility regime
- Conflicting exit conditions are forbidden

Explanation:
Multiple exit rules create undefined behavior.
This hierarchy ensures deterministic exits and clean risk modeling.

################################################
## 5. MULTI-AGENT BEHAVIOR RULES
################################################

### 5.1 Strategist MCP

Responsibilities:
- Generate strategies
- Optimize parameters
- Detect market regimes

Restrictions:
- Strategies written ONLY to backend/strategies/
- Vectorized calculations only (no candle loops)
- Must pass backtest, dry-run, and paper trade

Explanation:
Strategist MCP is a quant researcher, not an execution engine.
It must think statistically, not procedurally.

### 5.2 Developer MCP (SAFE SELF-HEALING)

Developer MCP operates in EXACTLY three phases:

1. OBSERVE
   - Read logs/error.log
   - Analyze stack traces
2. PROPOSE
   - Generate patch diff
   - Generate unit tests
3. EXECUTE ONLY IF ALL CONDITIONS PASS
   - ast.parse() success
   - Unit tests pass
   - ≥ 30-day backtest ≥ baseline
   - Paper-trade canary success

Direct hot-patching is FORBIDDEN.

Explanation:
Self-healing without guardrails is self-destruction.
This protocol prevents runaway AI behavior.

### 5.3 Oracle & Sentinel

Rules:
- News and sentiment CANNOT generate trades
- Sentiment modifies risk ONLY
- Low liquidity + hype = zero exposure

Explanation:
Sentiment is noisy, biased, and often manipulated.
It is useful only as a risk dampener.

################################################
## 6. EVENT-DRIVEN COMMUNICATION
################################################

- Redis Pub/Sub is mandatory
- Agents MUST NOT call each other directly
- No shared mutable memory
- Event flow:
  Oracle → Redis → Strategist → Redis → Predator Engine

Explanation:
Loose coupling ensures resilience.
If one agent fails, the system degrades gracefully.

################################################
## 7. BLACK SWAN PROTOCOL (ALWAYS ON)
################################################

Triggers:
- Single candle price gap > Xσ
- Exchange WebSocket disconnect > threshold
- API rate-limit cascade

Actions:
- Close all positions immediately
- Disable trading for 24h
- Snapshot logs, configs, and state

Explanation:
Black swan events cannot be predicted,
only survived.

################################################
## 8. WEALTH, VAULT & FEES
################################################

- 50% of net profit is skimmed to Vault
- Vault funds:
  - Are isolated from execution wallet
  - Are excluded from all risk calculations
- BNB balance check: hourly
- If BNB < $10 equivalent → market buy $15 BNB

Explanation:
The Vault converts trading success into permanent wealth.
Without it, gains remain exposed to future risk.

################################################
## 9. SECURITY & PERMISSIONS
################################################

- API keys via .env only
- Trade-only permissions
- No withdrawal logic allowed
- No private keys stored in code

################################################
## 10. FINAL RULE
################################################

If any rule is ambiguous,
the safest interpretation MUST be chosen.


#############################################
# FILE: Mimari.md
#############################################

# PROJECT PREDATOR v2.9 – SYSTEM ARCHITECTURE

################################################
## 1. SYSTEM OVERVIEW
################################################

PROJECT PREDATOR is an event-driven, multi-agent,
autonomous trading system designed as a micro hedge fund.

Primary goals:
- Positive expectancy
- Controlled drawdowns
- Long-term survivability
- Autonomous but constrained operation

################################################
## 2. AGENT ARCHITECTURE
################################################

Agents are independent, loosely coupled components.

### Agents:

- Strategist MCP
  - Strategy generation
  - Parameter optimization
  - Regime detection

- Predator Engine
  - Order execution
  - Exchange connectivity
  - Slippage control

- Developer MCP
  - Reliability engineering
  - Error analysis
  - Guarded self-healing

- Oracle & Sentinel
  - News ingestion
  - Sentiment analysis
  - Anomaly detection

- Fee & Wealth Manager
  - Vault management
  - Fee optimization
  - Balance checks

################################################
## 3. SIGNAL & EXECUTION FLOW
################################################

Market Data / News
        ↓
Oracle & Sentinel
        ↓ (Redis Event)
Strategist MCP
        ↓ (Signal + Risk Params)
Predator Engine
        ↓
Exchange

Risk checks can interrupt this flow at ANY stage.

################################################
## 4. RISK OVERRIDE FLOW
################################################

Signal Generated
        ↓
Adaptive Kelly Engine
        ↓
Drawdown Guard
        ↓
Sentiment Risk Modifier
        ↓
Execution OR Block

Risk always has veto power.

################################################
## 5. EXECUTION LAYER
################################################

- ccxt.pro WebSocket connections
- Limit orders preferred
- Stoploss placed on exchange
- Slippage-aware sizing
- Latency-sensitive design

################################################
## 6. DATA & STATE
################################################

Current:
- SQLite (WAL) for trades, positions, state
- Redis for events, cache, coordination

Planned evolution:
- PostgreSQL for scalability
- Redis Sentinel / KeyDB for HA
- Prometheus + Grafana for metrics

################################################
## 7. STRATEGY LIFECYCLE
################################################

Generate
→ Backtest
→ Dry Run
→ Paper Trade
→ Limited Capital
→ Full Allocation

Failure at ANY stage disables the strategy.

################################################
## 8. DEPLOYMENT MODEL
################################################

- Docker + docker-compose
- restart: always
- Shared volumes:
  - logs/
  - strategies/
- Stateless services where possible

################################################
## 9. DESIGN PHILOSOPHY
################################################

Autonomy without discipline is chaos.
Discipline without autonomy is inefficiency.

PROJECT PREDATOR balances both.
